---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { requireAuth } from "@/lib/auth-check";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";
const SITE_URL = import.meta.env.PUBLIC_SITE_URL || "http://localhost:4321";

// Check auth
let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}

const cookie = Astro.request.headers.get("cookie") || "";

// Fetch links
interface LinkItem {
  id: string;
  slug: string;
  originalUrl: string;
  clicks: number;
  expiresAt?: string;
  createdAt: string;
}

let links: LinkItem[] = [];
let totalLinks = 0;
let totalClicks = 0;

try {
  const res = await fetch(`${API_URL}/api/links`, {
    headers: { cookie },
    credentials: "include",
  });
  if (res.ok) {
    const data = await res.json();
    links = data.links || [];
    totalLinks = data.total || links.length;
    totalClicks = links.reduce((sum, l) => sum + (l.clicks || 0), 0);
  }
} catch (error) {
  console.error("Failed to fetch links:", error);
}

// Helper functions
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hours ago`;
  if (diffDays < 7) return `${diffDays} days ago`;
  return date.toLocaleDateString();
}

function isExpired(expiresAt?: string): boolean {
  if (!expiresAt) return false;
  return new Date(expiresAt) < new Date();
}
---

<DashboardLayout title="Links">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold">Short Links</h2>
        <p class="text-muted-foreground">Create and manage your shortened URLs</p>
      </div>
    </div>

    <!-- Create link form -->
    <div class="bg-card rounded-xl border border-border p-5">
      <h3 class="font-medium mb-4">Create a new short link</h3>
      <form id="create-link-form" class="space-y-4">
        <!-- URL Input Row -->
        <div class="flex flex-col sm:flex-row gap-3">
          <div class="flex-1">
            <label class="block text-sm text-muted-foreground mb-1.5">Destination URL</label>
            <input
              type="url"
              name="url"
              placeholder="https://example.com/your-long-url"
              required
              class="w-full px-4 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
            />
          </div>
          <div class="sm:self-end">
            <button
              type="submit"
              class="w-full sm:w-auto px-6 py-2 bg-accent text-accent-foreground rounded-lg font-medium text-sm hover:bg-accent/90 transition-colors whitespace-nowrap"
            >
              Shorten URL
            </button>
          </div>
        </div>

        <!-- Custom Slug Row (Locked) -->
        <div class="border-t border-border pt-4">
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm text-muted-foreground">Custom slug (optional)</label>
            <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-gradient-to-r from-amber-400 to-orange-500 text-white text-xs rounded-full font-medium shadow-sm">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
              PRO FEATURE
            </span>
          </div>
          <div class="relative group max-w-md">
            <div class="flex items-center">
              <span class="px-3 py-2 bg-muted border border-r-0 border-border rounded-l-lg text-sm text-muted-foreground">l/</span>
              <input
                type="text"
                id="custom-slug-input"
                name="slug"
                placeholder="my-custom-link"
                pattern="[a-zA-Z0-9-_]+"
                readonly
                class="flex-1 px-3 py-2 bg-muted/50 border border-border rounded-r-lg text-sm focus:outline-none cursor-not-allowed opacity-60"
              />
            </div>
            <div class="absolute inset-0 cursor-pointer hover:bg-accent/5 rounded-lg transition-colors flex items-center justify-center group-hover:backdrop-blur-[1px]" id="slug-overlay" title="Click to unlock PRO features">
              <div class="opacity-0 group-hover:opacity-100 transition-opacity bg-accent/90 text-accent-foreground px-3 py-1 rounded-md text-xs font-medium pointer-events-none">
                Click to unlock
              </div>
            </div>
          </div>
          <p class="text-xs text-muted-foreground mt-1.5">Create memorable, branded short links with custom slugs</p>
        </div>
      </form>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="bg-card rounded-xl border border-border p-5">
        <p class="text-sm text-muted-foreground">Total Links</p>
        <p class="text-2xl font-semibold">{totalLinks}</p>
      </div>
      <div class="bg-card rounded-xl border border-border p-5">
        <p class="text-sm text-muted-foreground">Total Clicks</p>
        <p class="text-2xl font-semibold">{totalClicks.toLocaleString()}</p>
      </div>
      <div class="bg-card rounded-xl border border-border p-5">
        <p class="text-sm text-muted-foreground">Active Links</p>
        <p class="text-2xl font-semibold">{links.filter(l => !isExpired(l.expiresAt)).length}</p>
      </div>
    </div>

    <!-- Links list -->
    {links.length === 0 ? (
      <div class="bg-card rounded-xl border border-border p-12 text-center">
        <div class="w-16 h-16 rounded-xl bg-muted flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
          </svg>
        </div>
        <h3 class="font-medium mb-1">No links yet</h3>
        <p class="text-sm text-muted-foreground">Create your first short link above</p>
      </div>
    ) : (
      <div class="bg-card rounded-xl border border-border overflow-hidden">
        <div class="px-5 py-4 border-b border-border flex items-center justify-between">
          <h3 class="font-medium">Your Links</h3>
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
            </svg>
            <input 
              type="text" 
              placeholder="Search links..." 
              class="pl-9 pr-4 py-1.5 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
            />
          </div>
        </div>
        
        <div class="divide-y divide-border">
          {links.map((link) => (
            <div class="px-5 py-4 hover:bg-muted/30 transition-colors">
              <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2">
                    <a 
                      href={`${API_URL}/l/${link.slug}`} 
                      target="_blank"
                      class="font-medium text-accent hover:underline"
                    >
                      l/{link.slug}
                    </a>
                    <button 
                      class="p-1 hover:bg-muted rounded transition-colors copy-btn" 
                      title="Copy"
                      data-copy={`${API_URL}/l/${link.slug}`}
                    >
                      <svg class="w-3.5 h-3.5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
                      </svg>
                    </button>
                    {isExpired(link.expiresAt) && (
                      <span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full">Expired</span>
                    )}
                  </div>
                  <p class="text-sm text-muted-foreground truncate mt-1">{link.originalUrl}</p>
                </div>
                
                <div class="flex items-center gap-6 text-sm">
                  <div class="flex items-center gap-1.5 text-muted-foreground">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/>
                    </svg>
                    <span>{(link.clicks || 0).toLocaleString()} clicks</span>
                  </div>
                  <div class="text-muted-foreground">{formatDate(link.createdAt)}</div>
                  <div class="flex items-center gap-1">
                    <button 
                      class="p-1.5 hover:bg-muted rounded-lg transition-colors text-red-500" 
                      title="Delete"
                      data-delete-id={link.id}
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}
  </div>

  <!-- Pricing Popup Modal -->
  <div id="pricing-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in">
    <div class="bg-background rounded-xl border border-border max-w-5xl w-full max-h-[90vh] overflow-y-auto shadow-2xl animate-in slide-in-from-bottom-4">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-background/95 backdrop-blur-md border-b border-border px-6 py-5 flex items-center justify-between z-10">
        <div>
          <h2 class="text-2xl font-semibold">Upgrade to unlock Custom Slugs</h2>
          <p class="text-sm text-muted-foreground mt-1">Choose a plan that fits your needs</p>
        </div>
        <button id="close-modal" class="p-2 hover:bg-muted rounded-lg transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Pricing Cards -->
      <div class="p-6 lg:p-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6">
          <!-- Starter Plan -->
          <div class="group rounded-xl bg-card border border-border p-6 flex flex-col transition-all duration-300 hover:shadow-xl hover:border-accent hover:-translate-y-1">
            <div class="space-y-2 mb-4">
              <h3 class="font-medium text-lg">Starter</h3>
              <p class="text-muted-foreground text-sm">For personal projects</p>
            </div>
            <div class="mb-5">
              <span class="font-bold text-3xl">$5</span>
              <span class="text-muted-foreground">/mo</span>
            </div>
            <a
              href="/app/settings/billing?plan=starter"
              class="w-full px-4 py-2.5 bg-muted text-foreground rounded-lg font-medium text-sm hover:bg-accent hover:text-accent-foreground transition-all duration-300 text-center group-hover:bg-accent group-hover:text-accent-foreground"
            >
              Subscribe
            </a>
            <ul class="flex flex-col gap-3 text-sm mt-5 pt-5 border-t border-border">
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">10 GB storage</span>
              </li>
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">1,000 API calls/day</span>
              </li>
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">Priority support</span>
              </li>
            </ul>
          </div>

          <!-- Pro Plan (Highlighted) -->
          <div class="group rounded-xl bg-card border-2 border-green-500 p-6 flex flex-col relative transition-all duration-300 hover:shadow-2xl hover:border-green-600 hover:-translate-y-1 hover:scale-105">
            <div class="absolute -top-3 left-1/2 -translate-x-1/2 px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs font-bold rounded-full shadow-lg group-hover:from-green-600 group-hover:to-emerald-600 transition-all">
              MOST POPULAR
            </div>
            <div class="space-y-2 mb-4">
              <h3 class="font-medium text-lg">Pro</h3>
              <p class="text-muted-foreground text-sm">For professionals</p>
            </div>
            <div class="mb-5">
              <span class="font-bold text-3xl">$10</span>
              <span class="text-muted-foreground">/mo</span>
            </div>
            <a
              href="/app/settings/billing?plan=pro"
              class="w-full px-4 py-2.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-medium text-sm hover:from-green-600 hover:to-emerald-600 transition-all duration-300 text-center shadow-lg hover:shadow-xl"
            >
              Subscribe Now
            </a>
            <ul class="flex flex-col gap-3 text-sm mt-5 pt-5 border-t border-border">
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">100 GB storage</span>
              </li>
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">Unlimited API calls</span>
              </li>
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-foreground font-medium">Custom domains</span>
              </li>
              <li class="flex items-center gap-2.5 bg-amber-50 dark:bg-amber-900/20 -mx-2 px-2 py-2 rounded-lg">
                <svg class="w-4 h-4 text-amber-500 flex-shrink-0 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span class="text-foreground font-semibold">Custom slugs</span>
              </li>
            </ul>
          </div>

          <!-- Team Plan -->
          <div class="group rounded-xl bg-card border border-border p-6 flex flex-col transition-all duration-300 hover:shadow-xl hover:border-accent hover:-translate-y-1">
            <div class="space-y-2 mb-4">
              <h3 class="font-medium text-lg">Team</h3>
              <p class="text-muted-foreground text-sm">For teams</p>
            </div>
            <div class="mb-5">
              <span class="font-bold text-3xl">$20</span>
              <span class="text-muted-foreground">/mo</span>
            </div>
            <a
              href="/app/settings/billing?plan=team"
              class="w-full px-4 py-2.5 bg-muted text-foreground rounded-lg font-medium text-sm hover:bg-accent hover:text-accent-foreground transition-all duration-300 text-center group-hover:bg-accent group-hover:text-accent-foreground"
            >
              Subscribe
            </a>
            <ul class="flex flex-col gap-3 text-sm mt-5 pt-5 border-t border-border">
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">1 TB storage</span>
              </li>
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">Everything in Pro</span>
              </li>
              <li class="flex items-center gap-2.5">
                <svg class="w-4 h-4 text-emerald-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                <span class="text-muted-foreground">Team collaboration</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<script define:vars={{ API_URL }}>
  // Pricing modal functionality
  const slugOverlay = document.getElementById('slug-overlay');
  const slugInput = document.getElementById('custom-slug-input');
  const pricingModal = document.getElementById('pricing-modal');
  const closeModalBtn = document.getElementById('close-modal');

  // Show pricing modal when clicking on custom slug field
  slugOverlay?.addEventListener('click', (e) => {
    e.preventDefault();
    pricingModal?.classList.remove('hidden');
  });

  slugInput?.addEventListener('click', (e) => {
    e.preventDefault();
    pricingModal?.classList.remove('hidden');
  });

  // Close modal
  closeModalBtn?.addEventListener('click', () => {
    pricingModal?.classList.add('hidden');
  });

  // Close modal when clicking outside
  pricingModal?.addEventListener('click', (e) => {
    if (e.target === pricingModal) {
      pricingModal.classList.add('hidden');
    }
  });

  // Close modal on ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !pricingModal?.classList.contains('hidden')) {
      pricingModal?.classList.add('hidden');
    }
  });

  // Create link form
  const form = document.getElementById('create-link-form');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const url = formData.get('url');
    const slug = formData.get('slug');

    try {
      const res = await fetch(`${API_URL}/api/links`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ url, slug: slug || undefined }),
      });

      if (res.ok) {
        window.location.reload();
      } else {
        const data = await res.json();
        alert(`Failed to create link: ${data.error || 'Unknown error'}`);
      }
    } catch (error) {
      alert(`Failed to create link: ${error.message}`);
    }
  });

  // Copy buttons
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const text = btn.dataset.copy;
      await navigator.clipboard.writeText(text);
      // Show feedback
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<svg class="w-3.5 h-3.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
    });
  });

  // Delete buttons
  document.querySelectorAll('[data-delete-id]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.deleteId;
      if (!confirm('Are you sure you want to delete this link?')) return;

      try {
        const res = await fetch(`${API_URL}/api/links/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(`Delete failed: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Delete failed: ${error.message}`);
      }
    });
  });
</script>
