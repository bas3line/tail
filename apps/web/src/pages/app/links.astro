---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import DateTimePicker from "@/components/DateTimePicker.astro";
import TimezoneSelect from "@/components/TimezoneSelect.astro";
import { requireAuth } from "@/lib/auth-check";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";
const SITE_URL = import.meta.env.PUBLIC_SITE_URL || "http://localhost:4321";

// Check auth
let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}

const cookie = Astro.request.headers.get("cookie") || "";

// Get filter from query params
const url = new URL(Astro.request.url);
const activeFilter = url.searchParams.get("filter") || "all";

// Fetch links with filter
interface LinkItem {
  id: string;
  slug: string;
  url: string;
  title?: string;
  description?: string;
  clicks: number;
  active: boolean;
  expiresAt?: string;
  startsAt?: string;
  createdAt: string;
  redirectType?: number;
  maxClicks?: number;
  timezone?: string;
}

let links: LinkItem[] = [];
let totalLinks = 0;
let totalClicks = 0;
let activeLinks = 0;
let expiredLinks = 0;

try {
  // Build API URL with filter
  let apiUrl = `${API_URL}/api/links?limit=100`;
  if (activeFilter === "active") {
    apiUrl += "&active=true";
  } else if (activeFilter === "inactive") {
    apiUrl += "&active=false";
  }

  const res = await fetch(apiUrl, {
    headers: { cookie },
    credentials: "include",
  });

  if (res.ok) {
    const data = await res.json();
    let allLinks = data.links || [];
    totalLinks = data.total || allLinks.length;

    // Calculate all stats from all links
    const now = new Date();
    allLinks.forEach(link => {
      totalClicks += link.clicks || 0;
      const expired = link.expiresAt && new Date(link.expiresAt) < now;
      const started = !link.startsAt || new Date(link.startsAt) <= now;

      if (!expired && started && link.active) {
        activeLinks++;
      }
      if (expired) {
        expiredLinks++;
      }
    });

    // Apply client-side filtering for expired and scheduled
    if (activeFilter === "expired") {
      links = allLinks.filter(l => l.expiresAt && new Date(l.expiresAt) < now);
    } else if (activeFilter === "scheduled") {
      links = allLinks.filter(l => l.startsAt && new Date(l.startsAt) > now);
    } else if (activeFilter === "all") {
      links = allLinks;
    } else {
      // active/inactive handled by API
      links = allLinks;
    }
  }
} catch (error) {
  console.error("Failed to fetch links:", error);
}

// Helper functions
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hours ago`;
  if (diffDays < 7) return `${diffDays} days ago`;
  return date.toLocaleDateString();
}

function isExpired(link: LinkItem): boolean {
  if (!link.expiresAt) return false;
  return new Date(link.expiresAt) < new Date();
}

function isScheduled(link: LinkItem): boolean {
  if (!link.startsAt) return false;
  return new Date(link.startsAt) > new Date();
}

function getLinkStatus(link: LinkItem): { label: string; color: string } {
  if (!link.active) return { label: "Inactive", color: "bg-gray-500" };
  if (isExpired(link)) return { label: "Expired", color: "bg-red-500" };
  if (isScheduled(link)) return { label: "Scheduled", color: "bg-yellow-500" };
  if (link.maxClicks && link.clicks >= link.maxClicks) return { label: "Max Clicks", color: "bg-orange-500" };
  return { label: "Active", color: "bg-green-500" };
}
---

<DashboardLayout title="Links">
  <div class="space-y-6">
    <!-- Header with Filter Tabs -->
    <div class="flex flex-col gap-4">
      <div>
        <h2 class="text-2xl font-semibold">Short Links</h2>
        <p class="text-muted-foreground">Create and manage your shortened URLs</p>
      </div>

      <!-- Filter Tabs -->
      <div class="flex gap-2 overflow-x-auto pb-2">
        <a
          href="/app/links?filter=all"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${activeFilter === "all" ? "bg-accent text-accent-foreground" : "bg-muted text-muted-foreground hover:bg-muted/80"}`}
        >
          All Links
        </a>
        <a
          href="/app/links?filter=active"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${activeFilter === "active" ? "bg-accent text-accent-foreground" : "bg-muted text-muted-foreground hover:bg-muted/80"}`}
        >
          Active
        </a>
        <a
          href="/app/links?filter=expired"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${activeFilter === "expired" ? "bg-accent text-accent-foreground" : "bg-muted text-muted-foreground hover:bg-muted/80"}`}
        >
          Expired
        </a>
        <a
          href="/app/links?filter=scheduled"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${activeFilter === "scheduled" ? "bg-accent text-accent-foreground" : "bg-muted text-muted-foreground hover:bg-muted/80"}`}
        >
          Scheduled
        </a>
        <a
          href="/app/links?filter=inactive"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap ${activeFilter === "inactive" ? "bg-accent text-accent-foreground" : "bg-muted text-muted-foreground hover:bg-muted/80"}`}
        >
          Inactive
        </a>
      </div>
    </div>

    <!-- Create link form -->
    <div class="bg-card rounded-xl border border-border p-5">
      <h3 class="font-medium mb-4">Create a new short link</h3>
      <form id="create-link-form" class="space-y-4">
        <!-- URL Input Row -->
        <div class="flex flex-col sm:flex-row gap-3">
          <div class="flex-1">
            <label class="block text-sm text-muted-foreground mb-1.5">Destination URL</label>
            <input
              type="url"
              name="url"
              placeholder="https://example.com/your-long-url"
              required
              class="w-full px-4 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
            />
          </div>
          <div class="sm:self-end">
            <button
              type="submit"
              class="w-full sm:w-auto px-6 py-2 bg-accent text-accent-foreground rounded-lg font-medium text-sm hover:bg-accent/90 transition-colors whitespace-nowrap"
            >
              Shorten URL
            </button>
          </div>
        </div>

        <!-- Custom Slug Row (Locked) -->
        <div class="border-t border-border pt-4">
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm text-muted-foreground">Custom slug (optional)</label>
            <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-gradient-to-r from-amber-400 to-orange-500 text-white text-xs rounded-full font-medium shadow-sm">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
              PRO FEATURE
            </span>
          </div>
          <div class="relative group max-w-md">
            <div class="flex items-center">
              <span class="px-3 py-2 bg-muted border border-r-0 border-border rounded-l-lg text-sm text-muted-foreground">l/</span>
              <input
                type="text"
                id="custom-slug-input"
                name="slug"
                placeholder="my-custom-link"
                pattern="[a-zA-Z0-9-_]+"
                readonly
                class="flex-1 px-3 py-2 bg-muted/50 border border-border rounded-r-lg text-sm focus:outline-none cursor-not-allowed opacity-60"
              />
            </div>
            <div class="absolute inset-0 cursor-pointer hover:bg-accent/5 rounded-lg transition-colors flex items-center justify-center group-hover:backdrop-blur-[1px]" id="slug-overlay" title="Click to unlock PRO features">
              <div class="opacity-0 group-hover:opacity-100 transition-opacity bg-accent/90 text-accent-foreground px-3 py-1 rounded-md text-xs font-medium pointer-events-none">
                Click to unlock
              </div>
            </div>
          </div>
          <p class="text-xs text-muted-foreground mt-1.5">Create memorable, branded short links with custom slugs</p>
        </div>

        <!-- Advanced Options (Collapsible) -->
        <div class="border-t border-border pt-4">
          <button type="button" id="toggle-advanced" class="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors">
            <svg id="advanced-icon" class="w-4 h-4 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
            </svg>
            Advanced Options
          </button>

          <div id="advanced-options" class="mt-4 space-y-4">
            <!-- Link Metadata Section -->
            <div class="border border-border rounded-lg p-4 bg-muted/30">
              <div class="flex items-center gap-2 mb-3">
                <h4 class="text-sm font-medium">Link Metadata</h4>
                <a
                  href="https://docs.tail.tools"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-muted hover:bg-accent hover:text-accent-foreground transition-colors"
                  title="Learn more about metadata"
                >
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </a>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="flex items-center gap-1.5 text-sm text-muted-foreground mb-1.5">
                    Title (optional)
                    <a
                      href="https://docs.tail.tools"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex text-muted-foreground hover:text-accent transition-colors"
                      title="Learn more"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </a>
                  </label>
                  <input
                    type="text"
                    name="title"
                    placeholder="My Campaign Link"
                    maxlength="200"
                    class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                  />
                  <p class="text-xs text-muted-foreground mt-1">Internal label for this link</p>
                </div>
                <div>
                  <label class="flex items-center gap-1.5 text-sm text-muted-foreground mb-1.5">
                    Description (optional)
                    <a
                      href="https://docs.tail.tools"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex text-muted-foreground hover:text-accent transition-colors"
                      title="Learn more"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </a>
                  </label>
                  <input
                    type="text"
                    name="description"
                    placeholder="Link description"
                    maxlength="500"
                    class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                  />
                  <p class="text-xs text-muted-foreground mt-1">Notes about this link's purpose</p>
                </div>
              </div>
            </div>

            <!-- Redirect Type & Max Clicks -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-muted-foreground mb-1.5">Redirect Type</label>
                <select
                  name="redirectType"
                  class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                >
                  <option value="302">302 - Temporary (Default)</option>
                  <option value="301">301 - Permanent</option>
                  <option value="307">307 - Temporary (Keep Method)</option>
                  <option value="308">308 - Permanent (Keep Method)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-muted-foreground mb-1.5">Max Clicks (optional)</label>
                <input
                  type="number"
                  name="maxClicks"
                  placeholder="Unlimited"
                  min="1"
                  class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                />
              </div>
            </div>

            <!-- Expiry Settings -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <DateTimePicker
                name="startsAt"
                label="Starts At (optional)"
                helpText="Link becomes active at this time"
              />
              <DateTimePicker
                name="expiresAt"
                label="Expires At (optional)"
                helpText="Link expires at this time"
              />
            </div>

            <!-- Timezone & Grace Period -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <TimezoneSelect
                name="timezone"
                label="Timezone (optional)"
                helpText="For scheduled start/expiry times"
              />
              <div>
                <label class="block text-sm text-muted-foreground mb-1.5">Grace Period (seconds)</label>
                <input
                  type="number"
                  name="gracePeriod"
                  placeholder="0"
                  min="0"
                  max="86400"
                  class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                />
                <p class="text-xs text-muted-foreground mt-1">Allow clicks after expiry</p>
              </div>
            </div>

            <!-- Auto-archive -->
            <div>
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  name="autoArchive"
                  class="w-4 h-4 rounded border-border text-accent focus:ring-2 focus:ring-accent/50"
                />
                <span class="text-sm text-muted-foreground">Auto-archive when expired</span>
              </label>
            </div>

            <!-- UTM Parameters -->
            <div class="border-t border-border pt-4">
              <div class="flex items-center gap-2 mb-3">
                <h4 class="text-sm font-medium">UTM Parameters</h4>
                <a
                  href="https://docs.tail.tools"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-muted hover:bg-accent hover:text-accent-foreground transition-colors"
                  title="Learn about UTM tracking"
                >
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </a>
              </div>
              <p class="text-xs text-muted-foreground mb-3">Track your marketing campaigns with UTM parameters (optional)</p>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="flex items-center gap-1.5 text-sm text-muted-foreground mb-1.5">
                    Source
                    <span class="inline-flex" title="Where traffic originates (e.g., newsletter, google, facebook)">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </span>
                  </label>
                  <input
                    type="text"
                    name="utmSource"
                    placeholder="e.g., newsletter"
                    maxlength="100"
                    class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                  />
                  <p class="text-xs text-muted-foreground mt-1">Traffic source</p>
                </div>
                <div>
                  <label class="flex items-center gap-1.5 text-sm text-muted-foreground mb-1.5">
                    Medium
                    <span class="inline-flex" title="Marketing medium (e.g., email, social, cpc)">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </span>
                  </label>
                  <input
                    type="text"
                    name="utmMedium"
                    placeholder="e.g., email"
                    maxlength="100"
                    class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                  />
                  <p class="text-xs text-muted-foreground mt-1">Marketing medium</p>
                </div>
                <div>
                  <label class="flex items-center gap-1.5 text-sm text-muted-foreground mb-1.5">
                    Campaign
                    <span class="inline-flex" title="Campaign name (e.g., summer-sale, product-launch)">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </span>
                  </label>
                  <input
                    type="text"
                    name="utmCampaign"
                    placeholder="e.g., summer-sale"
                    maxlength="100"
                    class="w-full px-3 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
                  />
                  <p class="text-xs text-muted-foreground mt-1">Campaign identifier</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
      <div class="bg-card rounded-xl border border-border p-5">
        <p class="text-sm text-muted-foreground">Total Links</p>
        <p class="text-2xl font-semibold">{totalLinks}</p>
      </div>
      <div class="bg-card rounded-xl border border-border p-5">
        <p class="text-sm text-muted-foreground">Active</p>
        <p class="text-2xl font-semibold text-green-500">{activeLinks}</p>
      </div>
      <div class="bg-card rounded-xl border border-border p-5">
        <p class="text-sm text-muted-foreground">Expired</p>
        <p class="text-2xl font-semibold text-red-500">{expiredLinks}</p>
      </div>
      <div class="bg-card rounded-xl border border-border p-5">
        <p class="text-sm text-muted-foreground">Total Clicks</p>
        <p class="text-2xl font-semibold">{totalClicks.toLocaleString()}</p>
      </div>
    </div>

    <!-- Links list -->
    {links.length === 0 ? (
      <div class="bg-card rounded-xl border border-border p-12 text-center">
        <div class="w-16 h-16 rounded-xl bg-muted flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
          </svg>
        </div>
        <h3 class="font-medium mb-1">No links yet</h3>
        <p class="text-sm text-muted-foreground">Create your first short link above</p>
      </div>
    ) : (
      <div class="bg-card rounded-xl border border-border overflow-hidden">
        <div class="px-5 py-4 border-b border-border flex items-center justify-between">
          <h3 class="font-medium">Your Links</h3>
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
            </svg>
            <input 
              type="text" 
              placeholder="Search links..." 
              class="pl-9 pr-4 py-1.5 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50"
            />
          </div>
        </div>
        
        <div class="divide-y divide-border">
          {links.map((link) => {
            const status = getLinkStatus(link);
            return (
              <div class="px-5 py-4 hover:bg-muted/30 transition-colors">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                      <a
                        href={`${API_URL}/l/${link.slug}`}
                        target="_blank"
                        class="font-medium text-accent hover:underline"
                      >
                        l/{link.slug}
                      </a>
                      <button
                        class="p-1 hover:bg-muted rounded transition-colors copy-btn"
                        title="Copy"
                        data-copy={`${API_URL}/l/${link.slug}`}
                      >
                        <svg class="w-3.5 h-3.5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
                        </svg>
                      </button>
                      <span class={`px-2 py-0.5 ${status.color} text-white text-xs rounded-full`}>{status.label}</span>
                      {link.title && (
                        <span class="px-2 py-0.5 bg-muted text-muted-foreground text-xs rounded-full">{link.title}</span>
                      )}
                    </div>
                    <p class="text-sm text-muted-foreground truncate mt-1">{link.url}</p>
                  </div>
                
                <div class="flex items-center gap-6 text-sm">
                  <div class="flex items-center gap-1.5 text-muted-foreground">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zM12 2.25V4.5m5.834.166l-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243l-1.59-1.59"/>
                    </svg>
                    <span>{(link.clicks || 0).toLocaleString()} clicks</span>
                  </div>
                  <div class="text-muted-foreground">{formatDate(link.createdAt)}</div>
                  <div class="flex items-center gap-1">
                    <a
                      href={`/app/links/${link.id}/analytics`}
                      class="p-1.5 hover:bg-muted rounded-lg transition-colors text-accent"
                      title="View Analytics"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/>
                      </svg>
                    </a>
                    <button
                      class="p-1.5 hover:bg-muted rounded-lg transition-colors text-red-500"
                      title="Delete"
                      data-delete-id={link.id}
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                      </svg>
                    </button>
                  </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    )}
  </div>

</DashboardLayout>

<!-- Success Modal -->
<div id="success-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-background rounded-xl max-w-md w-full p-6 shadow-2xl">
    <!-- Success Icon -->
    <div class="flex items-center justify-center mb-4">
      <div class="w-16 h-16 rounded-full bg-accent/10 flex items-center justify-center">
        <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
    </div>

    <!-- Title -->
    <h3 class="text-xl font-semibold text-center mb-2">Link Created Successfully!</h3>

    <!-- Short URL Display -->
    <div class="bg-muted rounded-lg p-4 mb-4">
      <p class="text-xs text-muted-foreground mb-1.5">Your short link:</p>
      <div class="flex items-center gap-2">
        <code id="modal-short-url" class="flex-1 text-sm font-mono text-accent">loading...</code>
        <button
          id="modal-copy-btn"
          class="p-2 hover:bg-background rounded transition-colors"
          title="Copy to clipboard"
        >
          <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-3">
      <button
        id="modal-copy-close-btn"
        class="flex-1 px-4 py-2 bg-accent text-accent-foreground rounded-lg font-medium text-sm hover:bg-accent/90 transition-colors border-2 border-dashed border-white/20"
      >
        Copy & Close
      </button>
      <button
        id="modal-close-btn"
        class="px-4 py-2 bg-muted text-foreground rounded-lg font-medium text-sm hover:bg-muted/80 transition-colors"
      >
        Close
      </button>
    </div>

    <!-- Bottom text -->
    <div class="mt-4 pt-4">
      <p class="text-xs text-center text-muted-foreground">
        View analytics and manage this link in your dashboard
      </p>
    </div>
  </div>
</div>

<script define:vars={{ API_URL }}>
  // Toggle advanced options
  const toggleAdvanced = document.getElementById('toggle-advanced');
  const advancedOptions = document.getElementById('advanced-options');
  const advancedIcon = document.getElementById('advanced-icon');

  toggleAdvanced?.addEventListener('click', () => {
    advancedOptions?.classList.toggle('hidden');
    advancedIcon?.classList.toggle('rotate-180');
  });

  // Redirect to pricing page when clicking on custom slug field
  const slugOverlay = document.getElementById('slug-overlay');
  const slugInput = document.getElementById('custom-slug-input');

  slugOverlay?.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = '/pricing';
  });

  slugInput?.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = '/pricing';
  });

  // Create link form
  const form = document.getElementById('create-link-form');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    // Build request body with all fields
    const body = {
      url: formData.get('url'),
    };

    // Add optional fields only if they have values
    const slug = formData.get('slug');
    if (slug && slug.trim()) body.slug = slug;

    const title = formData.get('title');
    if (title && title.trim()) body.title = title;

    const description = formData.get('description');
    if (description && description.trim()) body.description = description;

    const redirectType = formData.get('redirectType');
    if (redirectType) body.redirectType = redirectType;

    const maxClicks = formData.get('maxClicks');
    if (maxClicks && maxClicks.trim()) body.maxClicks = parseInt(maxClicks);

    const startsAt = formData.get('startsAt');
    if (startsAt && startsAt.trim()) {
      body.startsAt = new Date(startsAt).toISOString();
    }

    const expiresAt = formData.get('expiresAt');
    if (expiresAt && expiresAt.trim()) {
      body.expiresAt = new Date(expiresAt).toISOString();
    }

    const timezone = formData.get('timezone');
    if (timezone && timezone.trim()) body.timezone = timezone;

    const gracePeriod = formData.get('gracePeriod');
    if (gracePeriod && gracePeriod.trim()) body.gracePeriod = parseInt(gracePeriod);

    const autoArchive = formData.get('autoArchive');
    if (autoArchive === 'on') body.autoArchive = true;

    const utmSource = formData.get('utmSource');
    if (utmSource && utmSource.trim()) body.utmSource = utmSource;

    const utmMedium = formData.get('utmMedium');
    if (utmMedium && utmMedium.trim()) body.utmMedium = utmMedium;

    const utmCampaign = formData.get('utmCampaign');
    if (utmCampaign && utmCampaign.trim()) body.utmCampaign = utmCampaign;

    try {
      const res = await fetch(`${API_URL}/api/links`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body),
      });

      if (res.ok) {
        const data = await res.json();
        const shortUrl = `${API_URL}/l/${data.link.slug}`;

        // Show success modal
        showSuccessModal(shortUrl);

        // Reset form
        form.reset();
      } else {
        const data = await res.json();
        alert(`Failed to create link: ${data.error || 'Unknown error'}`);
      }
    } catch (error) {
      alert(`Failed to create link: ${error.message}`);
    }
  });

  // Success modal functionality
  const successModal = document.getElementById('success-modal');
  const modalShortUrl = document.getElementById('modal-short-url');
  const modalCopyBtn = document.getElementById('modal-copy-btn');
  const modalCopyCloseBtn = document.getElementById('modal-copy-close-btn');
  const modalCloseBtn = document.getElementById('modal-close-btn');
  let currentShortUrl = '';

  function showSuccessModal(shortUrl) {
    currentShortUrl = shortUrl;
    modalShortUrl.textContent = shortUrl;
    successModal?.classList.remove('hidden');
  }

  function closeSuccessModal() {
    successModal?.classList.add('hidden');
    // Reload page after closing to show new link in list
    window.location.reload();
  }

  async function copyToClipboard() {
    try {
      await navigator.clipboard.writeText(currentShortUrl);
      // Show feedback
      const originalText = modalCopyBtn.innerHTML;
      modalCopyBtn.innerHTML = '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      setTimeout(() => {
        modalCopyBtn.innerHTML = originalText;
      }, 1500);
    } catch (err) {
      alert('Failed to copy to clipboard');
    }
  }

  modalCopyBtn?.addEventListener('click', copyToClipboard);

  modalCopyCloseBtn?.addEventListener('click', async () => {
    await copyToClipboard();
    setTimeout(() => closeSuccessModal(), 500);
  });

  modalCloseBtn?.addEventListener('click', closeSuccessModal);

  // Close on backdrop click
  successModal?.addEventListener('click', (e) => {
    if (e.target === successModal) {
      closeSuccessModal();
    }
  });

  // Close on ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !successModal?.classList.contains('hidden')) {
      closeSuccessModal();
    }
  });

  // Copy buttons
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const text = btn.dataset.copy;
      await navigator.clipboard.writeText(text);
      // Show feedback
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<svg class="w-3.5 h-3.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
    });
  });

  // Delete buttons
  document.querySelectorAll('[data-delete-id]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.deleteId;
      if (!confirm('Are you sure you want to delete this link?')) return;

      try {
        const res = await fetch(`${API_URL}/api/links/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(`Delete failed: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Delete failed: ${error.message}`);
      }
    });
  });
</script>
