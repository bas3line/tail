---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { requireAuth } from "@/lib/auth-check";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";

// Check auth
let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}

const cookie = Astro.request.headers.get("cookie") || "";

// Fetch media
interface MediaItem {
  id: string;
  filename: string;
  originalName: string;
  mimeType: string;
  size: number;
  visibility: "public" | "private" | "unlisted";
  views: number;
  variants?: Record<string, any>;
  createdAt: string;
}

let mediaItems: MediaItem[] = [];
let totalMedia = 0;
let totalViews = 0;

try {
  const res = await fetch(`${API_URL}/api/media`, {
    headers: { cookie },
    credentials: "include",
  });
  if (res.ok) {
    const data = await res.json();
    mediaItems = data.media || [];
    totalMedia = data.total || mediaItems.length;
    totalViews = mediaItems.reduce((sum, m) => sum + (m.views || 0), 0);
  }
} catch (error) {
  console.error("Failed to fetch media:", error);
}

// Helper functions
function formatBytes(bytes: number): string {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
}

function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hours ago`;
  if (diffDays < 7) return `${diffDays} days ago`;
  return date.toLocaleDateString();
}

function isImage(mimeType: string): boolean {
  return mimeType.startsWith("image/");
}

function isVideo(mimeType: string): boolean {
  return mimeType.startsWith("video/");
}

function isPdf(mimeType: string): boolean {
  return mimeType === "application/pdf";
}
---

<DashboardLayout title="Media">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold">Media Library</h2>
        <p class="text-muted-foreground">
          {totalMedia > 0 ? `${totalMedia} item${totalMedia !== 1 ? "s" : ""} · ${totalViews.toLocaleString()} total views` : "Manage your images and media files"}
        </p>
      </div>
      <button 
        id="upload-btn"
        class="inline-flex items-center gap-2 px-4 py-2 bg-accent text-accent-foreground rounded-lg font-medium text-sm hover:bg-accent/90 transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
        </svg>
        Upload
      </button>
    </div>

    <!-- Filters -->
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
          </svg>
          <input 
            type="text" 
            placeholder="Search media..." 
            class="pl-10 pr-4 py-2 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50 w-64"
          />
        </div>
        <select class="px-4 py-2 bg-background border border-border rounded-lg text-sm">
          <option>All types</option>
          <option>Images</option>
          <option>Videos</option>
          <option>PDFs</option>
        </select>
      </div>
    </div>

    <!-- Drop zone -->
    <div 
      id="drop-zone"
      class="border-2 border-dashed border-border rounded-xl p-8 text-center hover:border-accent/50 hover:bg-accent/5 transition-colors cursor-pointer"
    >
      <input type="file" id="file-input" class="hidden" multiple accept="image/*,video/*,application/pdf" />
      <div class="flex flex-col items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-accent/10 flex items-center justify-center text-accent">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>
          </svg>
        </div>
        <div>
          <p class="font-medium">Drop images here or click to upload</p>
          <p class="text-sm text-muted-foreground">PNG, JPG, GIF, WebP, AVIF, MP4, PDF up to 50MB</p>
        </div>
      </div>
    </div>

    <!-- Media grid -->
    {mediaItems.length === 0 ? (
      <div class="bg-card rounded-xl border border-border p-12 text-center">
        <div class="w-16 h-16 rounded-xl bg-muted flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>
          </svg>
        </div>
        <h3 class="font-medium mb-1">No media yet</h3>
        <p class="text-sm text-muted-foreground mb-4">Upload your first image or video to get started</p>
        <button 
          class="inline-flex items-center gap-2 px-4 py-2 bg-accent text-accent-foreground rounded-lg font-medium text-sm hover:bg-accent/90 transition-colors"
          onclick="document.getElementById('file-input').click()"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
          </svg>
          Upload Media
        </button>
      </div>
    ) : (
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
        {mediaItems.map((item) => (
          <div class="group relative bg-card rounded-xl border border-border overflow-hidden hover:shadow-md transition-shadow">
            <div class="aspect-square bg-muted flex items-center justify-center">
              {isImage(item.mimeType) ? (
                <img 
                  src={`${API_URL}/media/stream/${item.id}`} 
                  alt={item.originalName}
                  class="w-full h-full object-cover"
                  loading="lazy"
                />
              ) : isVideo(item.mimeType) ? (
                <svg class="w-12 h-12 text-muted-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z"/>
                </svg>
              ) : isPdf(item.mimeType) ? (
                <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                </svg>
              ) : (
                <svg class="w-12 h-12 text-muted-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                </svg>
              )}
            </div>
            
            <!-- Hover overlay -->
            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
              <a 
                href={`${API_URL}/media/${item.id}`} 
                target="_blank"
                class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" 
                title="View"
              >
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </a>
              <button 
                class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors copy-btn" 
                title="Copy URL"
                data-copy={`${API_URL}/media/${item.id}`}
              >
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
                </svg>
              </button>
              <button 
                class="p-2 bg-red-500/80 hover:bg-red-500 rounded-lg transition-colors" 
                title="Delete"
                data-delete-id={item.id}
              >
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                </svg>
              </button>
            </div>
            
            <!-- File info -->
            <div class="p-3">
              <p class="text-sm font-medium truncate">{item.originalName}</p>
              <p class="text-xs text-muted-foreground">{formatBytes(item.size)} · {item.views} views</p>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
</DashboardLayout>

<script define:vars={{ API_URL }}>
  // File upload handling
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  const uploadBtn = document.getElementById('upload-btn');

  // Click to upload
  dropZone?.addEventListener('click', () => fileInput?.click());
  uploadBtn?.addEventListener('click', () => fileInput?.click());

  // Drag and drop
  dropZone?.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-accent', 'bg-accent/5');
  });

  dropZone?.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-accent', 'bg-accent/5');
  });

  dropZone?.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-accent', 'bg-accent/5');
    const files = e.dataTransfer?.files;
    if (files?.length) {
      await uploadFiles(files);
    }
  });

  // File input change
  fileInput?.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (files?.length) {
      await uploadFiles(files);
    }
  });

  async function uploadFiles(files) {
    for (const file of files) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(`${API_URL}/api/media/upload`, {
          method: 'POST',
          body: formData,
          credentials: 'include',
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(`Upload failed: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Upload failed: ${error.message}`);
      }
    }
  }

  // Copy buttons
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const text = btn.dataset.copy;
      await navigator.clipboard.writeText(text);
      // Brief visual feedback
      btn.classList.add('bg-green-500');
      setTimeout(() => btn.classList.remove('bg-green-500'), 1000);
    });
  });

  // Delete buttons
  document.querySelectorAll('[data-delete-id]').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = btn.dataset.deleteId;
      if (!confirm('Are you sure you want to delete this media?')) return;

      try {
        const res = await fetch(`${API_URL}/api/media/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(`Delete failed: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Delete failed: ${error.message}`);
      }
    });
  });
</script>
