---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import ToolPageLayout from "@/components/ToolPageLayout.astro";
import { requireAuth } from "@/lib/auth-check";

let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}
---

<DashboardLayout title="Base64 Encoder/Decoder">
  <ToolPageLayout
    title="Base64"
    description="Encode and decode Base64 strings. Support for files and images."
    icon="binary"
    tags={["Encode", "Decode", "File Support"]}
    status="free"
  >
    <div class="space-y-6">
      <!-- Mode Toggle -->
      <div class="flex gap-2 mb-4">
        <button
          id="encodeTab"
          class="px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium transition-colors"
        >
          Encode
        </button>
        <button
          id="decodeTab"
          class="px-4 py-2 bg-muted text-foreground rounded-lg text-sm font-medium hover:bg-muted/80 transition-colors"
        >
          Decode
        </button>
      </div>

      <!-- Input Type -->
      <div class="flex gap-2 mb-4">
        <button
          id="textModeBtn"
          class="px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium transition-colors"
        >
          Text
        </button>
        <button
          id="fileModeBtn"
          class="px-4 py-2 bg-muted text-foreground rounded-lg text-sm font-medium hover:bg-muted/80 transition-colors"
        >
          File
        </button>
      </div>

      <!-- Text Mode -->
      <div id="textMode" class="space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Input -->
          <div class="space-y-2">
            <label class="text-sm font-medium">Input</label>
            <textarea
              id="textInput"
              rows="12"
              placeholder="Enter text or Base64..."
              class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent font-mono text-sm resize-none"
            ></textarea>
          </div>

          <!-- Output -->
          <div class="space-y-2">
            <label class="text-sm font-medium">Output</label>
            <div class="relative">
              <textarea
                id="textOutput"
                rows="12"
                readonly
                placeholder="Result will appear here..."
                class="w-full px-4 py-3 rounded-lg border border-border bg-muted focus:outline-none font-mono text-sm resize-none"
              ></textarea>
              <button
                id="copyBtn"
                class="absolute top-3 right-3 p-2 rounded-lg bg-background hover:bg-background/80 transition-colors"
                title="Copy to clipboard"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <button
          id="processTextBtn"
          class="w-full px-6 py-3 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors"
        >
          Encode
        </button>
      </div>

      <!-- File Mode -->
      <div id="fileMode" class="hidden space-y-4">
        <div
          id="dropzone"
          class="border-2 border-dashed border-border rounded-lg p-12 text-center hover:border-accent transition-colors cursor-pointer"
        >
          <svg class="w-12 h-12 mx-auto mb-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
          </svg>
          <p class="text-sm font-medium mb-1">Drop a file here or click to browse</p>
          <p class="text-xs text-muted-foreground">Any file type, max 10MB</p>
          <input type="file" id="fileInput" class="hidden" />
        </div>

        <div id="fileResult" class="hidden">
          <label class="text-sm font-medium mb-2 block">Base64 Output</label>
          <div class="relative">
            <textarea
              id="fileOutput"
              rows="8"
              readonly
              class="w-full px-4 py-3 rounded-lg border border-border bg-muted focus:outline-none font-mono text-xs resize-none"
            ></textarea>
            <button
              id="copyFileBtn"
              class="absolute top-3 right-3 p-2 rounded-lg bg-background hover:bg-background/80 transition-colors"
              title="Copy to clipboard"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </ToolPageLayout>
</DashboardLayout>

<script>
  let isEncoding = true;

  const encodeTab = document.getElementById("encodeTab");
  const decodeTab = document.getElementById("decodeTab");
  const textModeBtn = document.getElementById("textModeBtn");
  const fileModeBtn = document.getElementById("fileModeBtn");
  const textMode = document.getElementById("textMode");
  const fileMode = document.getElementById("fileMode");
  const textInput = document.getElementById("textInput");
  const textOutput = document.getElementById("textOutput");
  const processTextBtn = document.getElementById("processTextBtn");

  encodeTab?.addEventListener("click", () => {
    isEncoding = true;
    encodeTab.className = "px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium transition-colors";
    decodeTab!.className = "px-4 py-2 bg-muted text-foreground rounded-lg text-sm font-medium hover:bg-muted/80 transition-colors";
    processTextBtn.textContent = "Encode";
  });

  decodeTab?.addEventListener("click", () => {
    isEncoding = false;
    decodeTab.className = "px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium transition-colors";
    encodeTab!.className = "px-4 py-2 bg-muted text-foreground rounded-lg text-sm font-medium hover:bg-muted/80 transition-colors";
    processTextBtn.textContent = "Decode";
  });

  textModeBtn?.addEventListener("click", () => {
    textModeBtn.className = "px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium transition-colors";
    fileModeBtn!.className = "px-4 py-2 bg-muted text-foreground rounded-lg text-sm font-medium hover:bg-muted/80 transition-colors";
    textMode?.classList.remove("hidden");
    fileMode?.classList.add("hidden");
  });

  fileModeBtn?.addEventListener("click", () => {
    fileModeBtn.className = "px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium transition-colors";
    textModeBtn!.className = "px-4 py-2 bg-muted text-foreground rounded-lg text-sm font-medium hover:bg-muted/80 transition-colors";
    textMode?.classList.add("hidden");
    fileMode?.classList.remove("hidden");
  });

  processTextBtn?.addEventListener("click", async () => {
    const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";
    
    try {
      const endpoint = isEncoding ? "base64/encode" : "base64/decode";
      const response = await fetch(`${API_URL}/api/tools/${endpoint}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ input: textInput.value }),
      });

      const data = await response.json();
      if (data.output) {
        textOutput.value = data.output;
      } else if (data.error) {
        alert(`Error: ${data.error}`);
      }
    } catch (error) {
      alert(`Error: ${(error as Error).message}`);
    }
  });

  document.getElementById("copyBtn")?.addEventListener("click", () => {
    textOutput.select();
    navigator.clipboard.writeText(textOutput.value);
  });

  // File handling
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("fileInput");
  const fileOutput = document.getElementById("fileOutput");
  const fileResult = document.getElementById("fileResult");

  dropzone?.addEventListener("click", () => fileInput?.click());

  fileInput?.addEventListener("change", (e) => {
    const file = (e.target).files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = e.target?.result as string;
        fileOutput.value = result.split(",")[1]; // Remove data URL prefix
        fileResult?.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById("copyFileBtn")?.addEventListener("click", () => {
    fileOutput.select();
    navigator.clipboard.writeText(fileOutput.value);
  });
</script>
