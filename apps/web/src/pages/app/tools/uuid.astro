---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import ToolPageLayout from "@/components/ToolPageLayout.astro";
import { requireAuth } from "@/lib/auth-check";

let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}
---

<DashboardLayout title="UUID Generator">
  <ToolPageLayout
    title="UUID Generator"
    description="Generate UUIDs v1, v4, v5. Bulk generation and validation."
    icon="fingerprint"
    tags={["v1", "v4", "v5", "Bulk"]}
    status="free"
  >
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm font-medium mb-2 block">UUID Version</span>
          <select
            id="uuidVersion"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          >
            <option value="v4" selected>v4 (Random)</option>
            <option value="v1">v1 (Timestamp)</option>
            <option value="v5">v5 (Name-based SHA-1)</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm font-medium mb-2 block">Quantity</span>
          <input
            type="number"
            id="quantity"
            min="1"
            max="1000"
            value="1"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          />
        </label>
      </div>

      <!-- v5 Options -->
      <div id="v5Options" class="hidden space-y-4">
        <label class="block">
          <span class="text-sm font-medium mb-2 block">Namespace</span>
          <select
            id="namespace"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          >
            <option value="dns">DNS</option>
            <option value="url">URL</option>
            <option value="oid">OID</option>
            <option value="x500">X500</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm font-medium mb-2 block">Name</span>
          <input
            type="text"
            id="name"
            placeholder="example.com"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          />
        </label>
      </div>

      <!-- Format Options -->
      <div class="space-y-3">
        <span class="text-sm font-medium">Format Options</span>
        <div class="flex flex-wrap gap-4">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="uppercase" class="rounded border-border" />
            <span class="text-sm">Uppercase</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="noDashes" class="rounded border-border" />
            <span class="text-sm">Remove dashes</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="braces" class="rounded border-border" />
            <span class="text-sm">Add braces</span>
          </label>
        </div>
      </div>

      <button
        id="generateBtn"
        class="w-full px-6 py-3 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors"
      >
        Generate UUIDs
      </button>

      <!-- Results -->
      <div id="results" class="hidden space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-medium">Generated UUIDs</h3>
          <button
            id="copyAllBtn"
            class="px-4 py-2 bg-muted hover:bg-muted/80 rounded-lg text-sm font-medium transition-colors"
          >
            Copy All
          </button>
        </div>
        
        <div class="space-y-2" id="uuidList"></div>
      </div>

      <!-- Validator -->
      <div class="border-t border-dashed pt-6 space-y-4">
        <h3 class="text-sm font-medium">UUID Validator</h3>
        <div class="flex gap-2">
          <input
            type="text"
            id="validateInput"
            placeholder="Paste UUID to validate..."
            class="flex-1 px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          />
          <button
            id="validateBtn"
            class="px-6 py-3 bg-muted hover:bg-muted/80 rounded-lg font-medium transition-colors"
          >
            Validate
          </button>
        </div>
        <div id="validationResult" class="hidden p-4 rounded-lg"></div>
      </div>
    </div>
  </ToolPageLayout>
</DashboardLayout>

<script>
  const uuidVersion = document.getElementById("uuidVersion");
  const v5Options = document.getElementById("v5Options");
  const generateBtn = document.getElementById("generateBtn");
  const results = document.getElementById("results");
  const uuidList = document.getElementById("uuidList");

  uuidVersion?.addEventListener("change", (e) => {
    const version = (e.target).value;
    v5Options?.classList.toggle("hidden", version !== "v5");
  });

  function formatUUID(uuid: string) {
    const uppercase = (document.getElementById("uppercase")).checked;
    const noDashes = (document.getElementById("noDashes")).checked;
    const braces = (document.getElementById("braces")).checked;

    let formatted = uuid;
    if (uppercase) formatted = formatted.toUpperCase();
    if (noDashes) formatted = formatted.replace(/-/g, "");
    if (braces) formatted = `{${formatted}}`;

    return formatted;
  }

  generateBtn?.addEventListener("click", async () => {
    const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";
    const quantity = parseInt((document.getElementById("quantity")).value);
    const version = uuidVersion.value;

    try {
      const response = await fetch(`${API_URL}/api/tools/uuid/bulk`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ 
          count: quantity, 
          version: version === "v5" ? "v4" : version 
        }),
      });

      const data = await response.json();
      
      if (data.uuids && uuidList) {
        uuidList.innerHTML = "";
        
        data.uuids.forEach((uuid: string) => {
          const formatted = formatUUID(uuid);

          const div = document.createElement("div");
          div.className = "flex items-center gap-2 p-3 bg-muted rounded-lg";
          div.innerHTML = `
            <code class="flex-1 text-sm font-mono">${formatted}</code>
            <button class="copy-single p-2 hover:bg-background rounded transition-colors" data-uuid="${formatted}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
              </svg>
            </button>
          `;
          uuidList.appendChild(div);
        });

        results?.classList.remove("hidden");

        // Add copy functionality
        document.querySelectorAll(".copy-single").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const uuid = (e.currentTarget).dataset.uuid!;
            navigator.clipboard.writeText(uuid);
          });
        });
      }
    } catch (error) {
      alert("Failed to generate UUIDs. Please try again.");
    }
  });

  document.getElementById("copyAllBtn")?.addEventListener("click", () => {
    const uuids = Array.from(document.querySelectorAll(".copy-single"))
      .map((btn) => (btn).dataset.uuid)
      .join("\n");
    navigator.clipboard.writeText(uuids);
  });

  // Validator
  document.getElementById("validateBtn")?.addEventListener("click", () => {
    const input = (document.getElementById("validateInput")).value.trim();
    const result = document.getElementById("validationResult");
    
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    const isValid = uuidRegex.test(input);

    if (result) {
      result.textContent = isValid ? "✓ Valid UUID" : "✗ Invalid UUID";
      result.className = `p-4 rounded-lg ${
        isValid
          ? "bg-emerald-50 dark:bg-emerald-950 text-emerald-600 dark:text-emerald-400"
          : "bg-red-50 dark:bg-red-950 text-red-600 dark:text-red-400"
      }`;
      result.classList.remove("hidden");
    }
  });
</script>
