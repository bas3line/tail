---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import ToolPageLayout from "@/components/ToolPageLayout.astro";
import { requireAuth } from "@/lib/auth-check";

let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}
---

<DashboardLayout title="Screenshot API">
  <ToolPageLayout
    title="Screenshot API"
    description="Capture any website programmatically."
    icon="camera"
    tags={["API"]}
    status="pro"
  >
    <div class="space-y-6">
      <div class="space-y-4">
        <label class="block">
          <span class="text-sm font-medium mb-2 block">Website URL</span>
          <input
            type="url"
            id="websiteUrl"
            placeholder="https://example.com"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          />
        </label>

        <label class="block">
          <span class="text-sm font-medium mb-2 block">Mode</span>
          <select
            id="mode"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          >
            <option value="viewport">Viewport</option>
            <option value="fullpage">Full Page</option>
            <option value="halfpage">Half Page</option>
            <option value="element">Specific Element</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm font-medium mb-2 block">Capture Area</span>
          <select
            id="captureArea"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          >
            <option value="">Entire Viewport</option>
            <option value="top">Top Half</option>
            <option value="middle">Middle Section</option>
            <option value="bottom">Bottom Half</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm font-medium mb-2 block">Format</span>
          <select
            id="format"
            class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
          >
            <option value="png">PNG</option>
            <option value="jpeg">JPEG</option>
            <option value="webp">WebP</option>
          </select>
        </label>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-medium mb-2 block">Width (px)</span>
            <input
              type="number"
              id="width"
              placeholder="1920"
              value="1920"
              class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
            />
          </label>

          <label class="block">
            <span class="text-sm font-medium mb-2 block">Height (px)</span>
            <input
              type="number"
              id="height"
              placeholder="1080"
              value="1080"
              class="w-full px-4 py-3 rounded-lg border border-border bg-background focus:outline-none focus:ring-2 focus:ring-accent"
            />
          </label>
        </div>

        <label class="flex items-center gap-2">
          <input type="checkbox" id="delay" class="rounded border-border" />
          <span class="text-sm">Wait for page load (5s delay)</span>
        </label>

        <div class="border-t border-border pt-4">
          <h3 class="text-sm font-medium mb-3">Custom Clip Region</h3>
          <div class="grid grid-cols-2 gap-4">
            <label class="block">
              <span class="text-xs text-muted-foreground mb-1 block">X Position</span>
              <input
                type="number"
                id="clipX"
                placeholder="0"
                class="w-full px-3 py-2 rounded-lg border border-border bg-background text-sm focus:outline-none focus:ring-2 focus:ring-accent"
              />
            </label>
            <label class="block">
              <span class="text-xs text-muted-foreground mb-1 block">Y Position</span>
              <input
                type="number"
                id="clipY"
                placeholder="0"
                class="w-full px-3 py-2 rounded-lg border border-border bg-background text-sm focus:outline-none focus:ring-2 focus:ring-accent"
              />
            </label>
            <label class="block">
              <span class="text-xs text-muted-foreground mb-1 block">Width</span>
              <input
                type="number"
                id="clipWidth"
                placeholder="Width"
                class="w-full px-3 py-2 rounded-lg border border-border bg-background text-sm focus:outline-none focus:ring-2 focus:ring-accent"
              />
            </label>
            <label class="block">
              <span class="text-xs text-muted-foreground mb-1 block">Height</span>
              <input
                type="number"
                id="clipHeight"
                placeholder="Height"
                class="w-full px-3 py-2 rounded-lg border border-border bg-background text-sm focus:outline-none focus:ring-2 focus:ring-accent"
              />
            </label>
          </div>
        </div>

        <button
          id="captureBtn"
          class="w-full px-6 py-3 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors"
        >
          Capture Screenshot
        </button>
      </div>

      <div id="preview" class="hidden space-y-4">
        <h3 class="text-sm font-medium">Screenshot Preview</h3>
        <div class="relative bg-muted rounded-lg overflow-hidden">
          <img id="screenshotImage" class="w-full" alt="Screenshot" />
          <a
            id="downloadLink"
            download="screenshot.png"
            class="absolute top-4 right-4 px-4 py-2 bg-black/50 rounded-lg text-white hover:bg-black/70 transition-colors text-sm font-medium"
          >
            Download
          </a>
        </div>
      </div>

      <div class="border-t border-dashed pt-6">
        <h3 class="text-sm font-medium mb-3">API Example</h3>
        <div class="bg-muted rounded-lg p-4">
          <pre class="text-xs overflow-x-auto"><code>{`curl -X POST https://api.tails.tools/v1/screenshot \\
  -H "Authorization: Bearer YOUR_API_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{
    "url": "https://example.com",
    "width": 1920,
    "height": 1080,
    "format": "png",
    "fullPage": false
  }'`}</code></pre>
        </div>
      </div>
    </div>
  </ToolPageLayout>
</DashboardLayout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";

  document.addEventListener("DOMContentLoaded", () => {
    const captureBtn = document.getElementById("captureBtn") as HTMLButtonElement;
    const websiteUrl = document.getElementById("websiteUrl") as HTMLInputElement;
    const mode = document.getElementById("mode") as HTMLSelectElement;
    const format = document.getElementById("format") as HTMLSelectElement;
    const width = document.getElementById("width") as HTMLInputElement;
    const height = document.getElementById("height") as HTMLInputElement;
    const delay = document.getElementById("delay") as HTMLInputElement;
    const captureArea = document.getElementById("captureArea") as HTMLSelectElement;
    const clipX = document.getElementById("clipX") as HTMLInputElement;
    const clipY = document.getElementById("clipY") as HTMLInputElement;
    const clipWidth = document.getElementById("clipWidth") as HTMLInputElement;
    const clipHeight = document.getElementById("clipHeight") as HTMLInputElement;
    const preview = document.getElementById("preview") as HTMLElement;
    const screenshotImage = document.getElementById("screenshotImage") as HTMLImageElement;
    const downloadLink = document.getElementById("downloadLink") as HTMLAnchorElement;

    captureBtn.addEventListener("click", async () => {
      const url = websiteUrl.value.trim();
      if (!url) {
        alert("Please enter a website URL");
        return;
      }

      try {
        captureBtn.disabled = true;
        captureBtn.textContent = "Capturing...";

        const options: any = {
          url,
          width: parseInt(width.value) || 1920,
          height: parseInt(height.value) || 1080,
          format: format.value || "png",
          fullPage: mode.value === "fullpage",
          halfPage: mode.value === "halfpage"
        };

        const x = parseInt(clipX.value);
        const y = parseInt(clipY.value);
        const cWidth = parseInt(clipWidth.value);
        const cHeight = parseInt(clipHeight.value);

        if (!isNaN(x) && !isNaN(y) && !isNaN(cWidth) && !isNaN(cHeight)) {
          options.clip = { x, y, width: cWidth, height: cHeight };
        }

        if (mode.value === "element") {
          const selector = prompt("Enter CSS selector for the element:");
          if (!selector) {
            captureBtn.disabled = false;
            captureBtn.textContent = "Capture Screenshot";
            return;
          }
          options.selector = selector;
        }

        if (captureArea.value) {
          options.captureArea = captureArea.value;
        }

        if (delay.checked) {
          options.waitFor = 5000;
        }

        const response = await fetch(`${API_URL}/v1/tools/screenshot`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(options),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: "Failed to capture screenshot" }));
          throw new Error(errorData.error || "Failed to capture screenshot");
        }

        const blob = await response.blob();
        const imageUrl = URL.createObjectURL(blob);

        screenshotImage.src = imageUrl;
        preview.classList.remove("hidden");

        const extension = format.value === "jpeg" ? "jpg" : format.value;
        downloadLink.href = imageUrl;
        downloadLink.download = `screenshot.${extension}`;

      } catch (error: any) {
        alert(`Error: ${error.message}`);
      } finally {
        captureBtn.disabled = false;
        captureBtn.textContent = "Capture Screenshot";
      }
    });
  });
</script>
