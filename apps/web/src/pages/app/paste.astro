---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { requireAuth } from "@/lib/auth-check";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";

// Check auth
let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}

const cookie = Astro.request.headers.get("cookie") || "";

// Fetch pastes
interface PasteItem {
  id: string;
  title?: string;
  content: string;
  language: string;
  visibility: "public" | "private" | "unlisted";
  views: number;
  expiresAt?: string;
  createdAt: string;
}

let pastes: PasteItem[] = [];
let totalPastes = 0;
let totalViews = 0;

try {
  const res = await fetch(`${API_URL}/api/pastes`, {
    headers: { cookie },
    credentials: "include",
  });
  if (res.ok) {
    const data = await res.json();
    pastes = data.pastes || [];
    totalPastes = data.total || pastes.length;
    totalViews = pastes.reduce((sum, p) => sum + (p.views || 0), 0);
  }
} catch (error) {
  console.error("Failed to fetch pastes:", error);
}

// Helper functions
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hours ago`;
  if (diffDays < 7) return `${diffDays} days ago`;
  return date.toLocaleDateString();
}

function formatExpiry(expiresAt?: string): string {
  if (!expiresAt) return "Never";
  const date = new Date(expiresAt);
  const now = new Date();
  if (date < now) return "Expired";
  const diffMs = date.getTime() - now.getTime();
  const diffDays = Math.floor(diffMs / 86400000);
  if (diffDays < 1) return "< 1 day";
  return `${diffDays} days`;
}

const languages = ["JavaScript", "TypeScript", "Python", "Go", "Rust", "SQL", "Bash", "JSON", "YAML", "Markdown", "HTML", "CSS", "Java", "C", "C++", "PHP", "Ruby"];
---

<DashboardLayout title="Paste">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold">Paste</h2>
        <p class="text-muted-foreground">
          {totalPastes > 0 ? `${totalPastes} paste${totalPastes !== 1 ? "s" : ""} · ${totalViews.toLocaleString()} total views` : "Share code snippets with syntax highlighting"}
        </p>
      </div>
    </div>

    <!-- Create paste form -->
    <form id="create-paste-form" class="bg-card rounded-xl border border-border overflow-hidden">
      <div class="px-5 py-4 border-b border-border flex flex-wrap items-center justify-between gap-3">
        <h3 class="font-medium">Create a new paste</h3>
        <div class="flex flex-wrap items-center gap-2">
          <select name="language" class="px-3 py-1.5 bg-background border border-border rounded-lg text-sm">
            {languages.map((lang) => (
              <option value={lang.toLowerCase()}>{lang}</option>
            ))}
          </select>
          <select name="visibility" class="px-3 py-1.5 bg-background border border-border rounded-lg text-sm">
            <option value="public">Public</option>
            <option value="unlisted">Unlisted</option>
            <option value="private">Private</option>
          </select>
          <select name="expiresIn" class="px-3 py-1.5 bg-background border border-border rounded-lg text-sm">
            <option value="">Never expires</option>
            <option value="1h">1 hour</option>
            <option value="1d">1 day</option>
            <option value="7d">7 days</option>
            <option value="30d">30 days</option>
          </select>
        </div>
      </div>
      <div class="relative">
        <textarea 
          name="content"
          placeholder="Paste your code here..."
          required
          class="w-full h-64 p-4 bg-[#1a1a1a] text-gray-300 font-mono text-sm resize-none focus:outline-none"
        ></textarea>
      </div>
      <div class="px-5 py-3 border-t border-border bg-muted/30 flex flex-wrap items-center justify-between gap-3">
        <input 
          type="text" 
          name="title"
          placeholder="Paste title (optional)"
          class="px-3 py-1.5 bg-background border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent/50 flex-1 min-w-[200px]"
        />
        <button 
          type="submit"
          class="px-6 py-2 bg-accent text-accent-foreground rounded-lg font-medium text-sm hover:bg-accent/90 transition-colors"
        >
          Create Paste
        </button>
      </div>
    </form>

    <!-- Pastes list -->
    {pastes.length === 0 ? (
      <div class="bg-card rounded-xl border border-border p-12 text-center">
        <div class="w-16 h-16 rounded-xl bg-muted flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5"/>
          </svg>
        </div>
        <h3 class="font-medium mb-1">No pastes yet</h3>
        <p class="text-sm text-muted-foreground">Create your first paste above</p>
      </div>
    ) : (
      <div class="bg-card rounded-xl border border-border overflow-hidden">
        <div class="px-5 py-4 border-b border-border flex items-center justify-between">
          <h3 class="font-medium">Your Pastes</h3>
        </div>
        
        <div class="divide-y divide-border">
          {pastes.map((paste) => (
            <div class="px-5 py-4 hover:bg-muted/30 transition-colors">
              <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2">
                    <a href={`/p/${paste.id}`} class="font-medium hover:text-accent transition-colors">
                      {paste.title || "Untitled"}
                    </a>
                    <span class="px-2 py-0.5 bg-muted text-muted-foreground text-xs rounded-full font-mono">
                      {paste.language}
                    </span>
                    {paste.visibility === "private" && (
                      <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
                      </svg>
                    )}
                    {paste.visibility === "unlisted" && (
                      <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Unlisted</span>
                    )}
                  </div>
                  <p class="text-sm text-muted-foreground mt-1">
                    {formatDate(paste.createdAt)} · {paste.views} views · Expires: {formatExpiry(paste.expiresAt)}
                  </p>
                </div>
                
                <div class="flex items-center gap-1">
                  <button 
                    class="p-1.5 hover:bg-muted rounded-lg transition-colors copy-btn" 
                    title="Copy link"
                    data-copy={`${API_URL}/p/${paste.id}`}
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
                    </svg>
                  </button>
                  <button 
                    class="p-1.5 hover:bg-muted rounded-lg transition-colors text-red-500" 
                    title="Delete"
                    data-delete-id={paste.id}
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}
  </div>
</DashboardLayout>

<script define:vars={{ API_URL }}>
  // Create paste form
  const form = document.getElementById('create-paste-form');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    // Calculate expiry date
    const expiresIn = formData.get('expiresIn');
    let expiresAt = null;
    if (expiresIn) {
      const now = new Date();
      const match = expiresIn.match(/(\d+)([hdm])/);
      if (match) {
        const [, num, unit] = match;
        if (unit === 'h') now.setHours(now.getHours() + parseInt(num));
        else if (unit === 'd') now.setDate(now.getDate() + parseInt(num));
        expiresAt = now.toISOString();
      }
    }

    try {
      const res = await fetch(`${API_URL}/api/pastes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          content: formData.get('content'),
          title: formData.get('title') || undefined,
          language: formData.get('language'),
          visibility: formData.get('visibility'),
          expiresAt,
        }),
      });

      if (res.ok) {
        window.location.reload();
      } else {
        const data = await res.json();
        alert(`Failed to create paste: ${data.error || 'Unknown error'}`);
      }
    } catch (error) {
      alert(`Failed to create paste: ${error.message}`);
    }
  });

  // Copy buttons
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const text = btn.dataset.copy;
      await navigator.clipboard.writeText(text);
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
    });
  });

  // Delete buttons
  document.querySelectorAll('[data-delete-id]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.deleteId;
      if (!confirm('Are you sure you want to delete this paste?')) return;

      try {
        const res = await fetch(`${API_URL}/api/pastes/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(`Delete failed: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Delete failed: ${error.message}`);
      }
    });
  });
</script>
