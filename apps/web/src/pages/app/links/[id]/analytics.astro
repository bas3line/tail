---
export const prerender = false;

import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { requireAuth } from "@/lib/auth-check";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";

// Check auth
let session;
try {
  session = await requireAuth(Astro.request);
} catch (response) {
  return response as Response;
}

const cookie = Astro.request.headers.get("cookie") || "";
const { id } = Astro.params;

// Fetch link details
interface LinkDetails {
  id: string;
  slug: string;
  url: string;
  title?: string;
  description?: string;
  clicks: number;
  active: boolean;
  expiresAt?: string;
  startsAt?: string;
  createdAt: string;
  redirectType?: number;
}

interface Analytics {
  totalClicks: number;
  uniqueClicks: number;
  clicksByCountry: Array<{ country: string; clicks: number }>;
  clicksByDevice: Array<{ device: string; clicks: number }>;
  clicksByBrowser: Array<{ browser: string; clicks: number }>;
  clicksByReferer: Array<{ referer: string; clicks: number }>;
}

let link: LinkDetails | null = null;
let analytics: Analytics | null = null;
let error: string | null = null;

try {
  // Fetch link details
  const linkRes = await fetch(`${API_URL}/api/links/${id}`, {
    headers: { cookie },
    credentials: "include",
  });

  if (linkRes.ok) {
    const data = await linkRes.json();
    link = data.link;
  } else {
    error = "Link not found";
  }

  // Fetch analytics
  if (link) {
    const analyticsRes = await fetch(`${API_URL}/api/links/${id}/analytics`, {
      headers: { cookie },
      credentials: "include",
    });

    if (analyticsRes.ok) {
      const data = await analyticsRes.json();
      analytics = data;
    }
  }
} catch (err) {
  console.error("Failed to fetch link analytics:", err);
  error = "Failed to load analytics";
}

if (!link) {
  return new Response(null, {
    status: 404,
    headers: { Location: "/app/links" },
  });
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}
---

<DashboardLayout title={`Analytics - ${link.slug}`}>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <a
        href="/app/links"
        class="p-2 hover:bg-muted rounded-lg transition-colors"
        title="Back to links"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
      </a>
      <div class="flex-1">
        <h2 class="text-2xl font-semibold">Link Analytics</h2>
        <div class="flex items-center gap-2 mt-1">
          <a
            href={`${API_URL}/l/${link.slug}`}
            target="_blank"
            class="text-accent hover:underline"
          >
            {API_URL}/l/{link.slug}
          </a>
          <button
            class="p-1 hover:bg-muted rounded transition-colors copy-btn"
            title="Copy"
            data-copy={`${API_URL}/l/${link.slug}`}
          >
            <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="flex gap-2">
        <a
          href={`${API_URL}/api/links/${id}/analytics/export?format=csv`}
          download
          class="px-4 py-2 bg-muted text-foreground rounded-lg font-medium text-sm hover:bg-muted/80 transition-colors"
        >
          Export CSV
        </a>
        <a
          href={`${API_URL}/api/links/${id}/qr?format=png&width=512`}
          download={`qr-${link.slug}.png`}
          class="px-4 py-2 bg-accent text-accent-foreground rounded-lg font-medium text-sm hover:bg-accent/90 transition-colors"
        >
          Download QR Code
        </a>
      </div>
    </div>

    <!-- Link Details Card -->
    <div class="bg-card rounded-xl border border-border p-6">
      <h3 class="font-medium mb-4">Link Details</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div>
          <p class="text-muted-foreground">Destination URL</p>
          <p class="font-medium truncate">{link.url}</p>
        </div>
        {link.title && (
          <div>
            <p class="text-muted-foreground">Title</p>
            <p class="font-medium">{link.title}</p>
          </div>
        )}
        <div>
          <p class="text-muted-foreground">Created</p>
          <p class="font-medium">{formatDate(link.createdAt)}</p>
        </div>
        <div>
          <p class="text-muted-foreground">Status</p>
          <p class="font-medium">
            {link.active ? (
              <span class="text-green-500">Active</span>
            ) : (
              <span class="text-red-500">Inactive</span>
            )}
          </p>
        </div>
        {link.expiresAt && (
          <div>
            <p class="text-muted-foreground">Expires</p>
            <p class="font-medium">{formatDate(link.expiresAt)}</p>
          </div>
        )}
        {link.startsAt && (
          <div>
            <p class="text-muted-foreground">Starts</p>
            <p class="font-medium">{formatDate(link.startsAt)}</p>
          </div>
        )}
      </div>
    </div>

    <!-- Stats Cards -->
    {analytics && (
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="bg-card rounded-xl border border-border p-5">
          <p class="text-sm text-muted-foreground">Total Clicks</p>
          <p class="text-3xl font-semibold">{analytics.totalClicks.toLocaleString()}</p>
        </div>
        <div class="bg-card rounded-xl border border-border p-5">
          <p class="text-sm text-muted-foreground">Unique Visitors</p>
          <p class="text-3xl font-semibold">{analytics.uniqueClicks.toLocaleString()}</p>
        </div>
      </div>
    )}

    {analytics && (
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Clicks by Country -->
        <div class="bg-card rounded-xl border border-border p-6">
          <h3 class="font-medium mb-4">Clicks by Country</h3>
          <div class="space-y-3">
            {analytics.clicksByCountry.slice(0, 10).map((item) => (
              <div class="flex items-center justify-between">
                <span class="text-sm">{item.country || "Unknown"}</span>
                <div class="flex items-center gap-2">
                  <div class="w-32 h-2 bg-muted rounded-full overflow-hidden">
                    <div
                      class="h-full bg-accent"
                      style={`width: ${(item.clicks / analytics.totalClicks) * 100}%`}
                    ></div>
                  </div>
                  <span class="text-sm font-medium w-12 text-right">{item.clicks}</span>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Clicks by Device -->
        <div class="bg-card rounded-xl border border-border p-6">
          <h3 class="font-medium mb-4">Clicks by Device</h3>
          <div class="space-y-3">
            {analytics.clicksByDevice.slice(0, 10).map((item) => (
              <div class="flex items-center justify-between">
                <span class="text-sm">{item.device || "Unknown"}</span>
                <div class="flex items-center gap-2">
                  <div class="w-32 h-2 bg-muted rounded-full overflow-hidden">
                    <div
                      class="h-full bg-accent"
                      style={`width: ${(item.clicks / analytics.totalClicks) * 100}%`}
                    ></div>
                  </div>
                  <span class="text-sm font-medium w-12 text-right">{item.clicks}</span>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Clicks by Browser -->
        <div class="bg-card rounded-xl border border-border p-6">
          <h3 class="font-medium mb-4">Clicks by Browser</h3>
          <div class="space-y-3">
            {analytics.clicksByBrowser.slice(0, 10).map((item) => (
              <div class="flex items-center justify-between">
                <span class="text-sm">{item.browser || "Unknown"}</span>
                <div class="flex items-center gap-2">
                  <div class="w-32 h-2 bg-muted rounded-full overflow-hidden">
                    <div
                      class="h-full bg-accent"
                      style={`width: ${(item.clicks / analytics.totalClicks) * 100}%`}
                    ></div>
                  </div>
                  <span class="text-sm font-medium w-12 text-right">{item.clicks}</span>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Clicks by Referer -->
        <div class="bg-card rounded-xl border border-border p-6">
          <h3 class="font-medium mb-4">Traffic Sources</h3>
          <div class="space-y-3">
            {analytics.clicksByReferer.slice(0, 10).map((item) => (
              <div class="flex items-center justify-between">
                <span class="text-sm truncate max-w-[200px]">{item.referer || "Direct"}</span>
                <div class="flex items-center gap-2">
                  <div class="w-32 h-2 bg-muted rounded-full overflow-hidden">
                    <div
                      class="h-full bg-accent"
                      style={`width: ${(item.clicks / analytics.totalClicks) * 100}%`}
                    ></div>
                  </div>
                  <span class="text-sm font-medium w-12 text-right">{item.clicks}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    )}
  </div>
</DashboardLayout>

<script define:vars={{ API_URL }}>
  // Copy button functionality
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const text = btn.dataset.copy;
      await navigator.clipboard.writeText(text);
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
    });
  });
</script>
