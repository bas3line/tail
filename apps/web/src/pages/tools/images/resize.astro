---
import ToolLayout from "@/layouts/ToolLayout.astro";
import Icon from "@/components/Icon.astro";
---

<ToolLayout
  title="Image Resize"
  description="Resize images to any dimension while maintaining quality. Supports JPEG, PNG, WebP, and more."
  category="Images"
>
  <div class="grid lg:grid-cols-2 gap-8">
    <!-- Upload Section -->
    <div class="space-y-6">
      <div
        id="dropzone"
        class="border-2 border-dashed border-border rounded-xl p-12 text-center hover:border-primary/50 transition-colors cursor-pointer"
      >
        <input type="file" id="fileInput" accept="image/*" class="hidden" />
        <div class="space-y-4">
          <div class="w-16 h-16 mx-auto rounded-full bg-muted flex items-center justify-center">
            <Icon name="upload" class="w-8 h-8 text-muted-foreground" />
          </div>
          <div>
            <p class="font-medium">Drop your image here</p>
            <p class="text-sm text-muted-foreground">or click to browse</p>
          </div>
          <p class="text-xs text-muted-foreground">
            Supports JPEG, PNG, WebP, GIF, AVIF
          </p>
        </div>
      </div>

      <!-- Preview -->
      <div id="preview" class="hidden">
        <div class="border border-dashed rounded-xl p-4 bg-card">
          <img id="previewImage" class="max-w-full h-auto rounded-lg mx-auto" />
          <div id="originalInfo" class="mt-4 text-sm text-muted-foreground text-center"></div>
        </div>
      </div>
    </div>

    <!-- Options Section -->
    <div class="space-y-6">
      <div class="border border-dashed rounded-xl p-6 bg-card space-y-6">
        <h3 class="font-semibold">Resize Options</h3>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Width (px)</label>
            <input
              type="number"
              id="width"
              placeholder="Auto"
              class="w-full px-4 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Height (px)</label>
            <input
              type="number"
              id="height"
              placeholder="Auto"
              class="w-full px-4 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Fit Mode</label>
          <select
            id="fit"
            class="w-full px-4 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
          >
            <option value="cover">Cover (crop to fill)</option>
            <option value="contain">Contain (fit within)</option>
            <option value="fill">Fill (stretch)</option>
            <option value="inside">Inside (shrink to fit)</option>
            <option value="outside">Outside (expand to cover)</option>
          </select>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="maintainRatio" checked class="rounded" />
          <label for="maintainRatio" class="text-sm">Maintain aspect ratio</label>
        </div>

        <button
          id="resizeBtn"
          disabled
          class="w-full py-3 px-4 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          Resize Image
        </button>
      </div>

      <!-- Result -->
      <div id="result" class="hidden border border-dashed rounded-xl p-6 bg-card space-y-4">
        <h3 class="font-semibold">Result</h3>
        <img id="resultImage" class="max-w-full h-auto rounded-lg mx-auto" />
        <div id="resultInfo" class="text-sm text-muted-foreground text-center"></div>
        <button
          id="downloadBtn"
          class="w-full py-3 px-4 bg-accent text-accent-foreground rounded-lg font-medium hover:bg-accent/90 transition-colors"
        >
          Download
        </button>
      </div>
    </div>
  </div>
</ToolLayout>

<script>
  const dropzone = document.getElementById("dropzone") as HTMLDivElement;
  const fileInput = document.getElementById("fileInput") as HTMLInputElement;
  const preview = document.getElementById("preview") as HTMLDivElement;
  const previewImage = document.getElementById("previewImage") as HTMLImageElement;
  const originalInfo = document.getElementById("originalInfo") as HTMLDivElement;
  const widthInput = document.getElementById("width") as HTMLInputElement;
  const heightInput = document.getElementById("height") as HTMLInputElement;
  const fitSelect = document.getElementById("fit") as HTMLSelectElement;
  const maintainRatio = document.getElementById("maintainRatio") as HTMLInputElement;
  const resizeBtn = document.getElementById("resizeBtn") as HTMLButtonElement;
  const result = document.getElementById("result") as HTMLDivElement;
  const resultImage = document.getElementById("resultImage") as HTMLImageElement;
  const resultInfo = document.getElementById("resultInfo") as HTMLDivElement;
  const downloadBtn = document.getElementById("downloadBtn") as HTMLButtonElement;

  let currentFile: File | null = null;
  let originalWidth = 0;
  let originalHeight = 0;
  let aspectRatio = 1;

  dropzone.addEventListener("click", () => fileInput.click());
  
  dropzone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropzone.classList.add("border-primary");
  });
  
  dropzone.addEventListener("dragleave", () => {
    dropzone.classList.remove("border-primary");
  });
  
  dropzone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropzone.classList.remove("border-primary");
    const files = e.dataTransfer?.files;
    if (files?.[0]) handleFile(files[0]);
  });

  fileInput.addEventListener("change", () => {
    if (fileInput.files?.[0]) handleFile(fileInput.files[0]);
  });

  function handleFile(file: File) {
    if (!file.type.startsWith("image/")) {
      alert("Please select an image file");
      return;
    }
    
    currentFile = file;
    const url = URL.createObjectURL(file);
    previewImage.src = url;
    
    previewImage.onload = () => {
      originalWidth = previewImage.naturalWidth;
      originalHeight = previewImage.naturalHeight;
      aspectRatio = originalWidth / originalHeight;
      
      originalInfo.textContent = `Original: ${originalWidth} × ${originalHeight} px (${(file.size / 1024).toFixed(1)} KB)`;
      preview.classList.remove("hidden");
      resizeBtn.disabled = false;
      
      widthInput.placeholder = String(originalWidth);
      heightInput.placeholder = String(originalHeight);
    };
  }

  widthInput.addEventListener("input", () => {
    if (maintainRatio.checked && widthInput.value) {
      const newWidth = parseInt(widthInput.value);
      heightInput.value = String(Math.round(newWidth / aspectRatio));
    }
  });

  heightInput.addEventListener("input", () => {
    if (maintainRatio.checked && heightInput.value) {
      const newHeight = parseInt(heightInput.value);
      widthInput.value = String(Math.round(newHeight * aspectRatio));
    }
  });

  resizeBtn.addEventListener("click", async () => {
    if (!currentFile) return;
    
    resizeBtn.disabled = true;
    resizeBtn.textContent = "Processing...";
    
    try {
      const formData = new FormData();
      formData.append("file", currentFile);
      if (widthInput.value) formData.append("width", widthInput.value);
      if (heightInput.value) formData.append("height", heightInput.value);
      formData.append("fit", fitSelect.value);
      
      const response = await fetch("/api/tools/images/resize", {
        method: "POST",
        body: formData,
      });
      
      if (!response.ok) throw new Error("Resize failed");
      
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      
      resultImage.src = url;
      resultImage.onload = () => {
        resultInfo.textContent = `Result: ${resultImage.naturalWidth} × ${resultImage.naturalHeight} px (${(blob.size / 1024).toFixed(1)} KB)`;
      };
      
      result.classList.remove("hidden");
      
      downloadBtn.onclick = () => {
        const a = document.createElement("a");
        a.href = url;
        a.download = `resized-${currentFile?.name || "image.png"}`;
        a.click();
      };
    } catch (error) {
      alert("Failed to resize image. Please try again.");
    } finally {
      resizeBtn.disabled = false;
      resizeBtn.textContent = "Resize Image";
    }
  });
</script>

